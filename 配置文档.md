# DrcomoMotionCast 配置文档

## 目录
1. [插件概述](#插件概述)
2. [配置文件结构](#配置文件结构)
3. [模型配置详解](#模型配置详解)
4. [全局设置配置](#全局设置配置)
5. [语言文件配置](#语言文件配置)
6. [完整配置示例](#完整配置示例)
7. [高级功能](#高级功能)

---

## 插件概述

DrcomoMotionCast 是一个 Minecraft 插件，用于将玩家的动作（攻击、飞行、滑翔、游泳等）映射到 MythicMobs 技能。支持 ModelEngine 集成，可根据玩家使用的模型执行不同的技能。

### 核心特性
- 支持 9 种玩家动作类型
- 5 种触发时机（立即、开始、结束、周期、持续时长）
- 完整的目标选择器系统
- 技能冷却机制
- 条件判断系统
- 热重载支持
- ModelEngine 集成

---

## 配置文件结构

```
plugins/DrcomoMotionCast/
├── models/              # 模型规则配置目录
│   ├── example.yml     # 示例模型配置
│   ├── model1.yml      # 自定义模型1
│   └── model2.yml      # 自定义模型2
├── settings.yml        # 全局设置
├── lang.yml           # 语言文件
└── config.yml         # 插件主配置（自动生成）
```

---

## 模型配置详解

### 基本结构
每个模型配置文件遵循以下结构：

```yaml
# 模型标识符
model: <string>

# 规则列表
rules:
  - # 规则1配置
  - # 规则2配置
  - # ...更多规则
```

### 规则配置参数

#### 必需参数

| 参数 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `id` | string | 规则唯一标识符，用于冷却和日志 | `"attack_basic"` |
| `action` | enum | 动作类型，见下方枚举表 | `attack` |
| `when` | enum | 触发时机，见下方枚举表 | `instant` |
| `skill` | string | MythicMobs 技能名称 | `"FireBall"` |

#### 可选参数

| 参数 | 类型 | 默认值 | 说明 | 示例 |
|------|------|--------|------|------|
| `target` | string | 空 | 目标选择器，见目标选择器章节 | `"@victim"` |
| `cd` | integer | 0 | 冷却时间（tick），1秒=20tick | `40` |
| `require` | string | 空 | 条件表达式，支持PAPI变量 | `"%player_health% > 10"` |
| `every` | integer | 1 | tick周期（仅when=tick时必需） | `10` |
| `after` | integer | 0 | 持续时长（仅when=duration时必需） | `60` |
| `meta` | object | {} | 元数据配置，见元数据章节 | 见下方详解 |

### 动作类型（action）枚举

| 值 | 说明 | 触发事件 | 适用状态 |
|---|---|---|---|
| `attack` | 攻击动作 | EntityDamageByEntityEvent | 玩家攻击其他实体时 |
| `damaged` | 受击动作 | EntityDamageEvent | 玩家受到伤害时 |
| `inboat` | 上下船动作 | VehicleEnterEvent/ExitEvent | 进入/离开船只时 |
| `ride` | 骑乘动作 | VehicleEnterEvent/ExitEvent | 骑乘/下坐骑时 |
| `fly` | 飞行动作 | PlayerToggleFlightEvent | 创造模式飞行切换时 |
| `glide` | 滑翔动作 | EntityToggleGlideEvent | 鞘翅滑翔状态切换时 |
| `swim` | 游泳动作 | EntityToggleSwimEvent | 游泳状态切换时 |
| `hover` | 悬停动作 | 自定义判定 | 空中悬停时（基于速度阈值） |
| `anim.play` | 动画播放 | ModelEngine集成 | ModelEngine动画事件 |

### 触发时机（when）枚举

| 值 | 说明 | 适用动作 | 所需参数 | 触发次数 | 支持CancelEvent |
|---|---|---|---|---|---|
| `instant` | 立即触发 | attack, damaged | 无 | 每次事件1次 | ✅ 是 |
| `start` | 状态开始时 | inboat, ride, fly, glide, swim, hover | 无 | 状态开始时1次 | ❌ 否 |
| `end` | 状态结束时 | inboat, ride, fly, glide, swim, hover | 无 | 状态结束时1次 | ❌ 否 |
| `tick` | 周期性触发 | fly, glide, swim, hover | `every` | 状态持续期间循环 | ❌ 否 |
| `duration` | 持续时长后 | fly, glide, swim, hover | `after` | 达到时长后1次 | ❌ 否 |

### 元数据配置（meta）

元数据用于细化动作的触发条件：

```yaml
meta:
  # 骑乘类型过滤（仅action=ride时生效）
  mount: <EntityType>
  
  # 船只限制（仅action=inboat时生效）
  boat: <boolean>
  
  # 悬停最小tick数（仅action=hover时生效）
  hover_min_ticks: <integer>
```

#### 支持的骑乘类型（mount）

| 值 | 说明 | Minecraft版本 |
|---|---|---|
| `HORSE` | 马匹 | 1.6+ |
| `DONKEY` | 驴 | 1.6+ |
| `MULE` | 骡子 | 1.6+ |
| `CAMEL` | 骆驼 | 1.20+ |
| `PIG` | 猪 | 1.0+ |
| `LLAMA` | 羊驼 | 1.11+ |
| `TRADER_LLAMA` | 商人羊驼 | 1.14+ |
| `STRIDER` | 炽足兽 | 1.16+ |

### 目标选择器系统

#### 内置选择器

| 选择器 | 说明 | 返回目标 | 使用场景 |
|-------|------|---------|---------|
| `@self` | 玩家自身 | 当前玩家 | 自我增益、治疗 |
| `@victim` | 最近受害者 | 玩家最近攻击的目标 | 攻击技能 |
| `@attacker` | 最近攻击者 | 最近攻击玩家的实体 | 反击技能 |
| `@vehicle` | 当前载具 | 玩家当前乘坐的载具 | 载具强化 |
| `@mount` | 当前坐骑 | 玩家当前骑乘的生物 | 坐骑技能 |

#### MythicMobs 原生选择器

插件也支持 MythicMobs 的原生目标选择器，如：
- `@Self`
- `@PlayersInRadius{r=10}`
- `@EntitiesInRadius{r=5,type=MONSTER}`

#### 目标选择器优先级

1. 自定义选择器（插件扩展）
2. 内置选择器（@self, @victim等）
3. MythicMobs原生选择器（以@开头）
4. 空值（由MythicMobs技能内部处理）

### 条件表达式系统

`require` 字段支持条件表达式，基于 DrcomoCoreLib 条件引擎：

```yaml
require: "%player_health% > 10 && %player_level% >= 5"
```

#### 支持的操作符
- 比较：`>`, `<`, `>=`, `<=`, `==`, `!=`
- 逻辑：`&&`, `||`, `!`
- 数学：`+`, `-`, `*`, `/`, `%`
- 括号：`()` 用于分组

#### 示例条件
```yaml
# 生命值大于10
require: "%player_health% > 10"

# 等级大于等于5且不在战斗中
require: "%player_level% >= 5 && %player_is_in_combat% == false"

# 金钱充足或拥有特定权限
require: "%vault_eco_balance% >= 100 || %player_has_permission_admin%"
```

### MythicMobs CancelEvent 支持

插件支持在技能中使用 MythicMobs 的 `CancelEvent` 机制来取消原始事件：

#### 支持的动作类型
- `action: attack` + `when: instant` - 可取消攻击伤害
- `action: damaged` + `when: instant` - 可取消受到的伤害

#### 使用示例
```yaml
# 攻击时释放技能并取消原始伤害
- id: magic_attack
  action: attack
  when: instant
  skill: MagicBlast  # 技能内含 CancelEvent
  target: @victim
  require: "%player_mana% >= 20"
```

对应的 MythicMobs 技能配置：
```yaml
# 在 MythicMobs 的技能文件中
MagicBlast:
  Skills:
  - damage{amount=50} @target
  - effect{effect=explosion} @target
  - cancelevent{sync=true}  # 取消原始攻击事件
  - message{msg="释放了魔法攻击！"} @caster
```

#### 重要说明
- **只有 `when: instant` 支持事件取消**
- **其他触发时机无法取消原始事件**，因为事件已经处理完毕
- 插件使用 `EventPriority.HIGH` 确保技能能够取消事件
- `sync=true` 参数确保同步取消事件

---

## 全局设置配置

文件位置：`plugins/DrcomoMotionCast/settings.yml`

```yaml
# 调试级别
debug: INFO                    # DEBUG|INFO|NONE

# 悬停检测配置
hover:
  min_ticks: 8                 # 连续满足条件的最小tick数
  v_abs_y: 0.03                # 垂直速度绝对值阈值
  h_speed: 0.06                # 水平速度阈值 sqrt(vx²+vz²)

# Tick调度器配置
tick:
  max_players_per_tick: 200    # 每tick处理的最大玩家数，超出分帧处理
```

注意：本版本已移除以下未被实际使用的全局键以保持配置简洁、避免误导：`cooldown.*`、`modelengine.*`、`mythicmobs.*`、`metrics.*`、`performance.*`。规则冷却请在各规则内通过 `cd` 字段设置；集成状态由插件自动检测，无需在 `settings.yml` 配置。

### 参数详解

#### 调试级别（debug）
- `DEBUG`：输出详细调试信息，包括事件触发、规则匹配等
- `INFO`：输出基本信息，如插件启动、配置重载等
- `NONE`：仅输出错误信息

#### 悬停检测（hover）
悬停状态判定基于以下条件：
1. 玩家离地且不在水中
2. 不处于游泳或滑翔状态
3. 垂直速度 |vy| ≤ `v_abs_y`
4. 水平速度 √(vx²+vz²) ≤ `h_speed`
5. 满足以上条件连续 ≥ `min_ticks` tick

#### Tick调度器（tick）
为避免性能问题，插件限制每tick处理的玩家数量。超出限制的玩家将在下一tick处理。

---

## 语言文件配置

文件位置：`plugins/DrcomoMotionCast/lang.yml`

```yaml
# 消息前缀
prefix: "&f[&bDrcomoMotionCast&r]&f "

# 重载消息
reloaded: "&a配置已重载，共 &e%files%&a 个模型文件，&e%rules%&a 条规则"
reload_failed: "&c配置重载失败：%error%"

# 规则执行消息
rule_fired: "&7规则 &e%rule%&7 → 技能 &b%skill%&7 (目标: &f%target%&7)"
rule_blocked_cooldown: "&7规则 &e%rule%&7 冷却中，还需 &c%remain%&7tick"
rule_blocked_condition: "&7规则 &e%rule%&7 条件不满足：&c%condition%"

# 错误消息
skill_cast_failed: "&c技能 &e%skill%&c 执行失败"
target_resolve_failed: "&c目标解析失败：&e%selector%"
model_not_found: "&c未找到模型 &e%model%&c 的配置"

# 状态消息
hover_start: "&7开始悬停"
hover_end: "&7结束悬停"
fly_start: "&7开始飞行"
fly_end: "&7结束飞行"

# 指令消息
command_no_permission: "&c您没有权限使用此命令"
command_player_only: "&c此命令只能由玩家执行"
command_unknown: "&c未知命令，使用 /drmotioncast help 查看帮助"

# 帮助信息
help_header: "&6=== DrcomoMotionCast 帮助 ==="
help_reload: "&e/drmotioncast reload &7- &f重载插件配置"
help_status: "&e/drmotioncast status &7- &f查看插件状态"
help_debug: "&e/drmotioncast debug <level> &7- &f设置调试级别"
```

### 占位符说明

| 占位符 | 说明 | 示例值 |
|--------|------|--------|
| `%files%` | 加载的配置文件数量 | `3` |
| `%rules%` | 加载的规则总数 | `25` |
| `%rule%` | 规则ID | `attack_basic` |
| `%skill%` | 技能名称 | `FireBall` |
| `%target%` | 目标描述 | `@victim` |
| `%remain%` | 剩余冷却时间 | `15` |
| `%condition%` | 条件表达式 | `%player_health% > 10` |
| `%selector%` | 目标选择器 | `@attacker` |
| `%model%` | 模型ID | `example_model` |
| `%error%` | 错误信息 | `文件不存在` |

---

## 完整配置示例

### 示例模型：战士职业
```yaml
# models/warrior.yml
model: warrior

rules:
  # 攻击技能组
  - id: basic_attack
    action: attack
    when: instant
    skill: WarriorSlash
    target: @victim
    cd: 10
    require: "%player_health% > 5"

  - id: critical_strike
    action: attack
    when: instant
    skill: WarriorCritical
    target: @victim
    cd: 100
    require: "%player_level% >= 10 && %random_1_100% <= 20"

  # 防御技能
  - id: defensive_stance
    action: damaged
    when: instant
    skill: WarriorDefense
    target: @self
    cd: 60
    require: "%player_health% <= 10"

  # 飞行技能组
  - id: flight_boost
    action: fly
    when: start
    skill: WarriorFlight
    target: @self

  - id: flight_aura
    action: fly
    when: tick
    every: 20
    skill: WarriorFlightAura
    target: @self

  - id: flight_slam
    action: fly
    when: end
    skill: WarriorSlam
    require: "%player_y% > 100"

  # 坐骑技能
  - id: horse_charge
    action: ride
    when: start
    skill: WarriorCharge
    meta:
      mount: HORSE

  - id: pig_ride_fun
    action: ride
    when: tick
    every: 40
    skill: PigParty
    target: @self
    meta:
      mount: PIG

  # 悬停技能
  - id: hover_meditation
    action: hover
    when: duration
    after: 100
    skill: WarriorMeditation
    target: @self
    meta:
      hover_min_ticks: 15

  # 游泳增益
  - id: swim_speed
    action: swim
    when: start
    skill: AquaticBoost
    target: @self
    require: "%player_world% == world_ocean"
```

### 示例模型：法师职业
```yaml
# models/mage.yml
model: mage

rules:
  # 魔法攻击
  - id: fireball
    action: attack
    when: instant
    skill: MageFireball
    target: @victim
    cd: 30
    require: "%player_mana% >= 20"

  - id: ice_shard
    action: attack
    when: instant
    skill: MageIceShard
    target: @victim
    cd: 20
    require: "%player_mana% >= 15 && %player_world_temperature% < 0.5"

  # 传送技能
  - id: blink
    action: damaged
    when: instant
    skill: MageBlink
    target: @self
    cd: 200
    require: "%player_health% <= 6"

  # 飞行魔法
  - id: levitation
    action: fly
    when: start
    skill: MageLevitation
    target: @self
    require: "%player_mana% >= 50"

  - id: mana_drain
    action: fly
    when: tick
    every: 60
    skill: ManaDrain
    target: @self

  # 滑翔强化
  - id: wind_boost
    action: glide
    when: start
    skill: MageWindBoost
    target: @self

  - id: glide_protection
    action: glide
    when: tick
    every: 10
    skill: GlideShield
    target: @self

  # 水下呼吸
  - id: water_breathing
    action: swim
    when: start
    skill: AquaticBreathing
    target: @self
    cd: 300

  # 悬停法术
  - id: float_spell
    action: hover
    when: start
    skill: MageFloat
    target: @self

  - id: arcane_orb
    action: hover
    when: tick
    every: 30
    skill: ArcaneOrb
    require: "%player_mana% >= 10"
```

---

## 高级功能

### 1. 热重载
使用命令 `/drmotioncast reload` 可以热重载所有配置，无需重启服务器。

### 2. 条件系统集成
支持 PlaceholderAPI 和 DrcomoCoreLib 条件引擎，可实现复杂的触发条件。

### 3. ModelEngine 集成
插件会自动检测玩家当前使用的 ModelEngine 模型，只有匹配的模型配置才会生效。

### 4. 性能优化
- 分帧处理大量玩家
- 规则缓存和索引
- 冷却数据自动清理
- 目标解析缓存

### 5. 调试功能
设置 `debug: DEBUG` 可查看详细的执行日志，包括：
- 事件触发情况
- 规则匹配过程  
- 目标解析结果
- 技能执行状态
- 性能指标

### 6. 扩展性
插件支持自定义目标解析器和条件求值器，可通过 API 进行扩展。

---

## 注意事项

1. **配置文件编码**：所有配置文件必须使用 UTF-8 编码
2. **YAML 格式**：注意缩进使用空格而非制表符
3. **技能名称**：确保 MythicMobs 技能存在且可执行
4. **权限配置**：合理配置权限避免普通玩家执行管理命令
5. **性能考虑**：避免在高频事件上配置过多规则
6. **版本兼容性**：确保 Minecraft 版本与实体类型兼容

---

## 故障排除

### 常见问题

1. **技能不执行**
   - 检查 MythicMobs 技能是否存在
   - 确认玩家模型ID与配置匹配
   - 检查条件表达式是否满足
   - 查看冷却是否生效

2. **配置重载失败**
   - 检查 YAML 语法是否正确
   - 确认必需字段是否填写
   - 查看错误日志获取详细信息

3. **目标解析失败**
   - 确认目标选择器语法正确
   - 检查目标实体是否存在
   - 查看上下文信息是否有效

### 日志查看
插件日志位于服务器日志中，搜索 `[DrcomoMotionCast]` 可快速定位相关信息。
