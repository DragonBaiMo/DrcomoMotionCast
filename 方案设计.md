# 架构总览

* 包名：`cn.drcomo.motioncast`
* 主类：`cn.drcomo.motioncast.DrcomoMotionCast`（Bukkit `JavaPlugin`）
* 关键模块

    * `config/ModelRuleLoader`：多文件加载、Schema 校验、热重载（基于 `DrcomoCoreLib` 的 `YamlUtil`、`ConfigValidator`）
    * `rules/ActionRule`：规则实体（动作+相位/计时+技能+目标+冷却+条件）
    * `state/PlayerStateSession`：玩家状态时间轴与计数器（飞行/滑翔/游泳/悬停/骑乘/在舟）
    * `engine/ActionEngine`：监听事件→匹配规则→冷却判断→解析目标→调用 MythicMobs 技能
    * `target/TargeterRegistry`：解析选择器（`@self,@victim,@attacker,@vehicle,@mount` 或原生 MythicMobs targeter 字符串）
    * `tick/TickScheduler`：仅在状态激活时逐帧计数（如 `when: tick` 与 `after:`）
    * `cooldown/CooldownService`：`playerUUID + ruleId` 级别冷却
    * `command/ReloadCommand`：`/DrcomoMotionCast reload`，含 Tab 补全与中文调试输出

> 线程与资源：尽量主线程执行业务；周期任务用 `DrcomoCoreLib.AsyncTaskManager` 的调度器封装 Bukkit 主线程调度；插件卸载时关闭监听与调度，防止泄露。

# 事件监听清单（对应“动作”）

* 攻击 `attack`：`org.bukkit.event.entity.EntityDamageByEntityEvent`（damager 为 `Player`）
* 受击 `damaged`：`org.bukkit.event.entity.EntityDamageEvent` / `EntityDamageByEntityEvent`（victim 为 `Player`）
* 上/下船 `inboat`：`org.bukkit.event.vehicle.VehicleEnterEvent`、`VehicleExitEvent`（过滤 `org.bukkit.entity.Boat`） ([hub.spigotmc.org][1])
* 骑乘/下坐骑 `ride`：同上 `VehicleEnter/ExitEvent`，过滤坐骑类型（马、猪等）
* 创造飞行开关 `fly`：`org.bukkit.event.player.PlayerToggleFlightEvent`（start/end） ([hub.spigotmc.org][2])
* 鞘翅滑翔 `glide`：`org.bukkit.event.entity.EntityToggleGlideEvent`（start/end） ([hub.spigotmc.org][3])
* 游泳状态 `swim`：`org.bukkit.event.entity.EntityToggleSwimEvent`（start/end） ([hub.spigotmc.org][4])
* 悬停 `hover`：自定义判定（见下）；通过 `PlayerMoveEvent` 更新速度与滞空状态
* 可选动画触发 `anim.play`：若接入 ModelEngine，可监听其公开事件或由规则直接“触发某技能”而非监听外部事件（ModelEngine 4 的事件与动画 API 参考其官方 Wiki）。([GitLab][5], [ticxo.github.io][6])

# 状态机与悬停判定

* 会话：`PlayerStateSession` 持有布尔态与计数器：`flying, gliding, swimming, inBoat, riding, hovering` 与对应 `tickSinceStart`。
* 悬停 `hover` 条件（默认，可在 `settings.yml` 覆盖）：玩家离地、非游泳、非滑翔；`|vy| ≤ 0.03` 且 `sqrt(vx²+vz²) ≤ 0.06` 连续 ≥ `hover.min_ticks`（默认 8t）即进入 `hover.start`；离开条件即 `hover.end`。激活期间由 `TickScheduler` 触发 `when: tick` 的规则。

# MythicMobs 技能调用（第三方 API，带完整导入路径与伪代码）

优先适配 MythicMobs v5+ 的 `MythicBukkit`，向下兼容 v4 的 `BukkitAPIHelper`：

* v5+（推荐）

    * 类：`io.lumine.mythic.bukkit.MythicBukkit`
    * 取 Helper 并施放：`MythicBukkit.inst().getAPIHelper().castSkill(...)`（示例见 MMOItems 源码引用） ([about.gitlab.com][7], [MythicCraft Minecraft Marketplace][8])
* v4（旧版）

    * 类：`io.lumine.xikage.mythicmobs.api.bukkit.BukkitAPIHelper`
    * 获取方式与重载签名（含实体/地点/目标集合）：官方 Javadoc 列出了 `castSkill(Entity e, String skillName, Location origin, Collection<Entity> eTargets, ...)` 等多重重载。([MythicCraft Minecraft Marketplace][9])

**伪代码：**

```java
// v5+ 首选
import io.lumine.mythic.bukkit.MythicBukkit; // MythicMobs v5+
import org.bukkit.entity.Player;
import org.bukkit.Location;
import org.bukkit.entity.Entity;
import java.util.Collection;

boolean cast(Player caster, String skill, Location origin, Collection<Entity> targets) {
    return MythicBukkit.inst()
        .getAPIHelper()
        .castSkill(caster, skill, origin, targets, /*lTargets*/ null, /*power*/ 1.0f);
}

// 兼容 v4（存在时优先使用 v5）
import io.lumine.xikage.mythicmobs.MythicMobs; // v4 主类
import io.lumine.xikage.mythicmobs.api.bukkit.BukkitAPIHelper;

boolean castV4(Player caster, String skill, Location origin, Collection<Entity> targets) {
    BukkitAPIHelper api = MythicMobs.inst().getAPIHelper();
    return api.castSkill(caster, skill, origin, targets, null, 1.0f);
}
```

> 说明：`castSkill` 的多重重载与获取方式以官方 Javadoc 为准；v5 使用 `MythicBukkit.inst()`，v4 使用 `MythicMobs.inst()` 与 `BukkitAPIHelper`。([MythicCraft Minecraft Marketplace][8], [MythicCraft Minecraft Marketplace][9])

# 目标选择器（Targeter）协议

* 固定关键词：`@self,@victim,@attacker,@vehicle,@mount`
* MythicMobs 原生 targeter 字符串：如 `@Self,@PlayersInRadius{r=6}`，插件将“直投 API，不预解析”。
* 自定义 selector：`name:param` 形式，交由 `TargeterRegistry` 注册的 `TargetResolver` 实现解析为 `Collection<Entity>` 后传给 `castSkill(...)` 的 `eTargets`。
* 解析优先级：自定义 → 固定关键词 → 以 `@` 开头的原生串（直投）。

# 配置规范（单模型=单文件）

* 路径：`plugins/DrcomoMotionCast/models/*.yml`
* 每条规则键集合（所有字段小写）

```yaml
# 顶层
model: <string>          # 模型/角色标识（可与文件名一致）
rules:                   # 规则数组
  - id: <string>         # 唯一ID（用于冷却与日志）
    action: <enum>       # attack|damaged|inboat|ride|fly|glide|swim|hover|anim.play
    when: <enum>         # instant|start|end|tick|duration
    every: <int>         # tick 周期（仅 when=tick）
    after: <int>         # 满足持续时长才触发（仅 when=duration，单位tick）
    skill: <string>      # MythicMobs 技能名（唯一绑定）
    target: <string>     # 目标选择器，见上；可留空=由MM内部targeter决定
    cd: <int>            # 冷却tick；默认0
    require: <string>    # 条件表达式（PAPI+逻辑运算，由 CoreLib 条件引擎解析）
    meta:                # 可选元数据
      mount: <enum>      # 过滤骑乘类型，如 HORSE|PIG；动作=ride时生效
      boat: <bool>       # 仅船；动作=inboat时生效
      hover_min_ticks: <int> # 覆盖悬停阈值
```

# 模型示例 `models/zy_js1.yml`

```yaml
model: zy_js1
rules:
  - id: atk
    action: attack
    when: instant
    skill: JS1_Attack
    target: @victim
    cd: 10

  - id: fly_start
    action: fly
    when: start
    skill: JS1_FlyStart

  - id: fly_charge
    action: fly
    when: duration
    after: 20
    skill: JS1_FlyCharge

  - id: fly_aura
    action: fly
    when: tick
    every: 10
    skill: JS1_FlyAura

  - id: fly_end
    action: fly
    when: end
    skill: JS1_FlyEnd

  - id: ride_pig
    action: ride
    when: start
    skill: JS1_MountPig
    meta:
      mount: PIG

  - id: hover_start
    action: hover
    when: start
    skill: JS1_HoverStart

  - id: hover_tick
    action: hover
    when: tick
    every: 20
    skill: JS1_HoverTick

  - id: hover_end
    action: hover
    when: end
    skill: JS1_HoverEnd
```

# 全局设置 `settings.yml`

```yaml
debug: INFO                  # DEBUG|INFO|NONE，可在运行时切换
hover:
  min_ticks: 8               # 连续满足阈值的最小tick
  v_abs_y: 0.03              # |vy|
  h_speed: 0.06              # sqrt(vx^2+vz^2)
tick:
  max_players_per_tick: 200  # 每帧处理上限，超额分帧
```

# 语言文件 `lang.yml`

```yaml
prefix: "&f[&bDrcomoMotionCast&r]&f "
reloaded: "&a配置已重载，共 &e%files%&a 个模型文件"
rule_fired: "&7规则 &e%rule% &7→ 技能 &b%skill%"
rule_blocked_cooldown: "&7规则 &e%rule% &7冷却中，还需 &c%remain%t"
```

# 指令与权限

* 指令：`/DrcomoMotionCast reload`
* Tab：`reload`
* 权限：`drcomo.motioncast.reload`
* `plugin.yml`

```yaml
name: DrcomoMotionCast
main: cn.drcomo.motioncast.DrcomoMotionCast
version: 1.0.0
api-version: 1.18
depend: [DrcomoCoreLib]
softdepend: [MythicMobs, ModelEngine]
commands:
  DrcomoMotionCast:
    description: Motion→Skill 映射
    usage: /DrcomoMotionCast reload
    aliases: [dmc]
permissions:
  drcomo.motioncast.reload:
    default: op
```

# 触发流程（伪代码，含关键导入路径）

```java
// 监听示例：飞行
import org.bukkit.event.player.PlayerToggleFlightEvent;
@EventHandler
public void onToggleFly(PlayerToggleFlightEvent e) {
  Player p = e.getPlayer();
  boolean start = e.isFlying(); // true=start false=end
  session(p).setFlying(start);
  session(p).resetCounter("fly", start);
  if (start) fireRules(p, "fly", "start"); else fireRules(p, "fly", "end");
}

// 监听滑翔
import org.bukkit.event.entity.EntityToggleGlideEvent;
@EventHandler
public void onGlide(EntityToggleGlideEvent e) {
  if (!(e.getEntity() instanceof Player p)) return;
  boolean start = e.isGliding();
  session(p).setGliding(start);
  session(p).resetCounter("glide", start);
  fireRules(p, "glide", start ? "start" : "end");
}

// 每tick（仅有激活状态玩家）
void tick(Player p) {
  // 1) duration：计数达到 after 触发一次
  // 2) tick：every 周期触发
  for (var st : activeStates(p)) {
    inc(st);
    triggerDurationIfReached(p, st);
    triggerTickIfDue(p, st);
  }
  // 悬停检测（基于 move/velocity 滤波）
  if (hoverNow(p) && !session(p).isHovering()) { enterHover(p); }
  else if (!hoverNow(p) && session(p).isHovering()) { exitHover(p); }
}

// 统一触发
void fireRules(Player p, String action, String when) {
  for (ActionRule r : repo.match(modelOf(p), action, when)) {
    if (cooldown.block(p, r)) continue;
    var targets = targeter.resolve(p, r.getTarget(), contextFromLastEvent(p));
    boolean ok = mythic.cast(p, r.getSkill(), p.getLocation(), targets); // 见上文 castSkill
    logRule(p, r, ok);
    cooldown.set(p, r);
  }
}
```

# 目标解析内置项

* `@self`=玩家自身
* `@victim`=最近一次 `attack` 的受击者
* `@attacker`=最近一次 `damaged` 的攻击者
* `@vehicle`=当前乘坐载具
* `@mount`=当前坐骑（若有）
* 传入 `@Something{...}` 这类 **原生 MythicMobs targeter** 时，**不做预解析**，直接让技能内部 targeter 生效（仍提供 `eTargets` 为空的 `castSkill` 调用即可，签名见官方 Javadoc）。([MythicCraft Minecraft Marketplace][9])

# 性能与安全

* 事件优先驱动，计时仅对“激活中”的状态创建轻量 tick 跟踪；大服下设置 `max_players_per_tick` 分帧处理。
* 所有监听在 `onDisable()` 注销；`AsyncTaskManager.close()` 收口；文件监视器 `YamlUtil.stopAllWatches()` 关闭。
* 冷却以 `System.nanoTime()` → tick 近似或全局 tick 计数器抽象，避免受 TPS 波动影响逻辑语义。

# 集成要点与来源

* MythicMobs v5：`io.lumine.mythic.bukkit.MythicBukkit` 存在且为主入口；常见三方也用 `MythicBukkit.inst().getAPIHelper().castSkill(...)`。([MythicCraft Minecraft Marketplace][8], [about.gitlab.com][7])
* v4 Javadoc 中 `BukkitAPIHelper.castSkill(...)` 提供多重重载与 `MythicMobs.inst().getAPIHelper()` 获取方式。([MythicCraft Minecraft Marketplace][9])
* 事件依据 Spigot API：`EntityToggleGlideEvent`、`PlayerToggleFlightEvent`、`EntityToggleSwimEvent`、`VehicleEnter/ExitEvent`。([hub.spigotmc.org][3])

需要我把上述 YAML Schema 做成 `ConfigValidator` 规则与最小可运行骨架（含监听器与指令类）吗？

[1]: https://hub.spigotmc.org/javadocs/spigot/org/bukkit/event/vehicle/VehicleEnterEvent.html?utm_source=chatgpt.com "VehicleEnterEvent (Spigot-API 1.21.8-R0.1-SNAPSHOT API)"
[2]: https://hub.spigotmc.org/javadocs/spigot/org/bukkit/event/player/PlayerToggleFlightEvent.html?utm_source=chatgpt.com "Class PlayerToggleFlightEvent"
[3]: https://hub.spigotmc.org/javadocs/bukkit/org/bukkit/event/entity/EntityToggleGlideEvent.html?utm_source=chatgpt.com "Class EntityToggleGlideEvent"
[4]: https://hub.spigotmc.org/javadocs/bukkit/org/bukkit/event/entity/EntityToggleSwimEvent.html?utm_source=chatgpt.com "EntityToggleSwimEvent (Spigot-API 1.21.8-R0. ..."
[5]: https://git.mythiccraft.io/mythiccraft/model-engine-4/-/wikis/API/Basic/Events/diff?version_id=85a198aa276032515065220ef89f9ffb042017bb&utm_source=chatgpt.com "Changes · Events · Wiki · MythicCraft / Model Engine 4 - GitLab"
[6]: https://ticxo.github.io/Model-Engine-Javadocs/?utm_source=chatgpt.com "Overview (api R3.1.6 API)"
[7]: https://gitlab.com/phoenix-dvpmt/mmoitems/-/blob/1289-disable-droping/MMOItems-API/src/main/java/net/Indyuce/mmoitems/comp/mythicmobs/crafting/MythicMobsSkillTrigger.java?utm_source=chatgpt.com "MythicMobsSkillTrigger.java - MMOItems"
[8]: https://www.mythiccraft.io/javadocs/mythic/io/lumine/mythic/bukkit/MythicBukkit.html?utm_source=chatgpt.com "MythicBukkit (Mythic 5.4.0-SNAPSHOT API)"
[9]: https://mythicmobs.net/javadocs/io/lumine/xikage/mythicmobs/api/bukkit/BukkitAPIHelper.html?utm_source=chatgpt.com "BukkitAPIHelper (MythicMobs 4.11.0-SNAPSHOT API)"
